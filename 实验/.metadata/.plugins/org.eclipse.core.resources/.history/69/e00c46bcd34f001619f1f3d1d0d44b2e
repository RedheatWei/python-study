#!/usr/bin/env python
#_*_ coding:utf-8 _*_
'''
Created on 2016年7月22日
Email: weipeng@sinashow.com
@author: Redheat

'''
import zipfile,sys
from ftplib import FTP
##########conf##########
ftp_server='ftp.intra.sinashow.com' #ftp地址
username='weipeng' #ftp用户名
password='weipeng##231' #ftp密码
zipfilename = 'zipfile.zip' #压缩后的文件名
uploadpath = '/' #上传文件路径
ftp_reconnect = 3 #ftp失败重连次数
######################
#文件列表
def createFileList():
    filenamelist = ['route.sh','update_python.sh','zabbix_agent.sh']
    return filenamelist
#压缩文件
def zipFile(filenamelist):
    try:    
        z = zipfile.ZipFile(zipfilename, 'w')
        for filename in filenamelist:
            z.write(filename)
    except Exception,e:
        print "Error! %s:%s. zip file faild!" %  (Exception,e)
        sys.exit()
    else:
        z.close()
        print "zip file success!"
#连接ftp
def ftpconnect():
    ftp=FTP()  
    ftp.set_debuglevel(1) #打开调试级别2，显示详细信息  
    try: 
        ftp.connect(ftp_server,21) #连接  
        ftp.login(username,password) #登录，如果匿名登录则用空串代替即可  
    except Exception,e:
        print "Error! %s:%s. ftp connect faild!" %  (Exception,e)
        return 0
    else:
        print "connect ftp success!"
        return ftp
#上传文件
def uploadFile(ftp): 
    bufsize = 1024
    try:
        fp = open(zipfilename,'rb')  
        ftp.storbinary('STOR '+ uploadpath ,fp,bufsize) #上传文件
        ftp.set_debuglevel(0)
        fp.close() #关闭文件  
        ftp.quit()
    except Exception,e:
        print "Error! %s:%s. upload file faild!" % (Exception,e)
#主函数
def main():
    filenamelist = createFileList()
    print filenamelist
    for i in range(1,ftp_reconnect+1):
        ftp = ftpconnect()
        if ftp != 0:
            zipFile(filenamelist)
            uploadfile(ftp)
            sys.exit()
        else:
            print 'connect ftp faild %s!' % i
if __name__ == '__main__':
    main()
        
        
        
